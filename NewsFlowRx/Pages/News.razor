@page "/"
@inject HttpClient Http
@inject ToastService ToastService
@inject NavigationManager Navigation
@using System.Text.Json
@using System.Text.Json.Serialization
@using System.Reactive.Linq
@using System.Reactive.Subjects

@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@implements IDisposable

<div class="container mt-4">
    <h4 class="mb-4">ニュース検索Rx</h4>

    <!-- 検索条件入力エリア -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center mb-3">
                <Button Color="Color.Secondary"
                       Icon="fa-solid fa-times"
                       Size="Size.Small"
                       OnClick="ClearSearch">
                    クリア
                </Button>
                <h6 class="card-title mb-0 ms-3">検索条件</h6>
            </div>

            <!-- キーワード入力 -->
            <div class="mb-3">
                <label for="keywords" class="form-label small text-muted">キーワード（スペース区切りでAND検索）</label>
                <BootstrapInput @bind-Value="searchKeywords"
                               placeholder="例: AI 人工知能 技術"
                               DisplayText="キーワード（スペース区切りでAND検索）"
                               @oninput="OnKeywordInput" />
            </div>

            <!-- 期間指定 -->
            <div class="row mb-3">
                <div class="col-12 col-sm-6 mb-3 mb-sm-0">
                    <label for="startdate" class="form-label small text-muted">開始日</label>
                    <DateTimePicker @bind-Value="dateFrom"
                                   DateFormat="yyyy/MM/dd"
                                   MaxValue="DateTime.Today"
                                   ViewMode="DatePickerViewMode.Date"
                                   DisplayText="開始日"
                                   OnValueChanged="OnDateFromChanged" />
                </div>
                <div class="col-12 col-sm-6">
                    <label for="enddate" class="form-label small text-muted">終了日</label>
                    <DateTimePicker @bind-Value="dateTo"
                                   DateFormat="yyyy/MM/dd"
                                   MaxValue="DateTime.Today"
                                   ViewMode="DatePickerViewMode.Date"
                                   DisplayText="終了日"
                                   OnValueChanged="OnDateToChanged" />
                </div>
            </div>

            <!-- 言語と並び替え -->
            <div class="row mb-3">
                <div class="col-12 col-sm-6 mb-3 mb-sm-0">
                    <label for="language" class="form-label small text-muted">言語</label>
                    <Select @bind-Value="selectedLanguage"
                           DisplayText="言語"
                           Items="@languageOptions"
                           OnSelectedItemChanged="OnLanguageChanged" />
                </div>
                <div class="col-12 col-sm-6">
                    <label for="sortby" class="form-label small text-muted">並び替え</label>
                    <Select @bind-Value="selectedSortBy"
                           DisplayText="並び替え"
                           Items="@sortByOptions"
                           OnSelectedItemChanged="OnSortByChanged" />
                </div>
            </div>

            <!-- Rx.NET情報表示 -->
            <div class="mt-3">
                <small class="text-muted">
                    <i class="fa-solid fa-circle-info"></i>
                    <strong>完全自動検索:</strong> すべての条件変更で自動的に検索を実行（キーワードは0.5秒後）
                    @if (isLoading)
                    {
                        <span class="ms-2">
                            <i class="fa-solid fa-spinner fa-spin"></i> 検索中...
                        </span>
                    }
                </small>
            </div>
        </div>
    </div>

    <!-- 検索結果表示エリア -->
    @if (searchResults != null)
    {
        <div class="card">
            <div class="card-body">
                <h6 class="card-title mb-3">
                    検索結果: @searchResults.TotalResults 件
                </h6>

                @if (searchResults.Articles == null || searchResults.Articles.Count == 0)
                {
                    <div class="alert alert-info" role="alert">
                        該当する記事が見つかりませんでした。
                    </div>
                }
                else
                {
                    <div class="d-flex flex-column gap-3">
                        @foreach (var article in searchResults.Articles)
                        {
                            <div class="card article-card" style="cursor: pointer; transition: all 0.2s;"
                                 @onclick="@(() => OpenArticle(article.Url))">
                                <div class="card-body p-3">
                                    <div class="d-flex gap-3">
                                        <!-- 画像エリア -->
                                        <div class="flex-shrink-0">
                                            @if (!string.IsNullOrEmpty(article.UrlToImage))
                                            {
                                                <img src="@article.UrlToImage"
                                                     alt="@article.Title"
                                                     style="width: 120px; height: 120px; object-fit: cover; border-radius: 4px;" />
                                            }
                                            else
                                            {
                                                <div style="width: 120px; height: 120px; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                                                    <i class="fa-solid fa-image fa-2x text-muted"></i>
                                                </div>
                                            }
                                        </div>

                                        <!-- テキストエリア -->
                                        <div class="flex-grow-1 d-flex flex-column" style="min-width: 0;">
                                            <!-- タイトル（1行） -->
                                            <h6 class="mb-1 text-truncate" style="font-weight: 600;">
                                                @article.Title
                                            </h6>

                                            <!-- 説明文（2行） -->
                                            <p class="text-muted mb-2 flex-grow-1" style="overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.4; font-size: 0.875rem;">
                                                @(article.Description ?? "説明文がありません")
                                            </p>

                                            <!-- 情報源と日付（1行） -->
                                            <small class="text-muted text-truncate">
                                                @article.Source?.Name  |  @article.PublishedAt?.ToString("yyyy/MM/dd HH:mm")
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .article-card:hover {
        background-color: #f8f9fa;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    }
</style>

@code {
    // 検索条件
    private string searchKeywords = string.Empty;
    private DateTime? dateFrom = DateTime.Today.AddDays(-7);
    private DateTime? dateTo = DateTime.Today;
    private string selectedLanguage = "jp";
    private string selectedSortBy = "publishedAt";

    // 状態管理
    private bool isLoading = false;
    private NewsApiResponse? searchResults;

    private string ApiKey = string.Empty;
    private string NewsAPIUrl = string.Empty;

    // Rx.NET用のSubject
    private readonly Subject<string> keywordSubject = new();
    private readonly Subject<string> languageSubject = new();
    private readonly Subject<DateTime?> dateFromSubject = new();
    private readonly Subject<DateTime?> dateToSubject = new();
    private readonly Subject<string> sortBySubject = new();
    private IDisposable? searchSubscription;

    // Select用のオプション
    private List<SelectedItem> languageOptions = new()
    {
        new SelectedItem("jp", "日本語"),
        new SelectedItem("en", "英語"),
        new SelectedItem("de", "ドイツ語"),
        new SelectedItem("es", "スペイン語"),
        new SelectedItem("fr", "フランス語"),
        new SelectedItem("it", "イタリア語"),
        new SelectedItem("zh", "中国語")
    };

    private List<SelectedItem> sortByOptions = new()
    {
        new SelectedItem("publishedAt", "公開日時"),
        new SelectedItem("relevancy", "関連度"),
        new SelectedItem("popularity", "人気度")
    };

    protected override void OnInitialized()
    {
        ApiKey = Configuration["ApiKeys:NewsAPIKey"] ?? "YOUR_NEWS_API_KEY";
        NewsAPIUrl = Configuration["NewsAPIUrl"] ?? "https://NewsAPI";

        // Rx.NETのリアクティブパイプラインをセットアップ
        SetupReactiveSearch();
    }

    private void SetupReactiveSearch()
    {
        // キーワードストリーム: Throttle + DistinctUntilChanged
        var keywordStream = keywordSubject
            .Throttle(TimeSpan.FromMilliseconds(500))  // 0.5秒待機
            .DistinctUntilChanged();                   // 同じ値は無視

        // 言語ストリーム: DistinctUntilChanged
        var languageStream = languageSubject
            .DistinctUntilChanged();                   // 同じ値は無視

        // 期間ストリーム: DistinctUntilChanged
        var dateFromStream = dateFromSubject
            .DistinctUntilChanged();

        var dateToStream = dateToSubject
            .DistinctUntilChanged();

        // 並び替えストリーム: DistinctUntilChanged
        var sortByStream = sortBySubject
            .DistinctUntilChanged();

        // CombineLatest: すべての検索条件を監視
        searchSubscription = Observable.CombineLatest(
            keywordStream,
            languageStream,
            dateFromStream,
            dateToStream,
            sortByStream,
            (keyword, language, from, to, sortBy) => new
            {
                Keyword = keyword,
                Language = language,
                DateFrom = from,
                DateTo = to,
                SortBy = sortBy
            }
        )
        .SelectMany(async searchParams =>           // Switch相当: 古いリクエストを自動キャンセル
        {
            // 空のキーワードの場合は検索しない
            if (string.IsNullOrWhiteSpace(searchParams.Keyword))
            {
                return (NewsApiResponse?)null;
            }

            return await PerformSearchWithAllParams(
                searchParams.Keyword,
                searchParams.Language,
                searchParams.DateFrom,
                searchParams.DateTo,
                searchParams.SortBy
            );
        })
        .Subscribe(
            result =>
            {
                searchResults = result;
                InvokeAsync(StateHasChanged);
            },
            error =>
            {
                System.Console.WriteLine($"Error in reactive search: {error.Message}");
                InvokeAsync(StateHasChanged);
            }
        );

        // 初期値を送信
        languageSubject.OnNext(selectedLanguage);
        dateFromSubject.OnNext(dateFrom);
        dateToSubject.OnNext(dateTo);
        sortBySubject.OnNext(selectedSortBy);
    }

    public void OnKeywordInput(ChangeEventArgs e)
    {
        searchKeywords = e.Value?.ToString() ?? string.Empty;
        keywordSubject.OnNext(searchKeywords);
    }

    public Task OnLanguageChanged(SelectedItem item)
    {
        selectedLanguage = item.Value;
        languageSubject.OnNext(selectedLanguage);
        return Task.CompletedTask;
    }

    public Task OnDateFromChanged(DateTime? value)
    {
        dateFrom = value;
        dateFromSubject.OnNext(value);
        return Task.CompletedTask;
    }

    public Task OnDateToChanged(DateTime? value)
    {
        dateTo = value;
        dateToSubject.OnNext(value);
        return Task.CompletedTask;
    }

    public Task OnSortByChanged(SelectedItem item)
    {
        selectedSortBy = item.Value;
        sortBySubject.OnNext(selectedSortBy);
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        searchSubscription?.Dispose();
        keywordSubject?.Dispose();
        languageSubject?.Dispose();
        dateFromSubject?.Dispose();
        dateToSubject?.Dispose();
        sortBySubject?.Dispose();
    }

    // リアクティブ検索用の内部メソッド（すべてのパラメータ対応）
    public async Task<NewsApiResponse?> PerformSearchWithAllParams(
        string keyword,
        string language,
        DateTime? from,
        DateTime? to,
        string sortBy)
    {
        if (string.IsNullOrWhiteSpace(keyword))
        {
            return null;
        }

        isLoading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            // キーワードをスペースで分割してAND条件用に連結
            var keywords = string.Join(" AND ", keyword.Split(' ', StringSplitOptions.RemoveEmptyEntries));

            // URLエンコード
            var encodedKeywords = Uri.EscapeDataString(keywords);
            var fromStr = from?.ToString("yyyy-MM-dd") ?? string.Empty;
            var toStr = to?.ToString("yyyy-MM-dd") ?? string.Empty;

            // NewsAPI エンドポイント構築
            var url = $"{NewsAPIUrl}?q={encodedKeywords}" +
                      $"&from={fromStr}&to={toStr}" +
                      $"&language={language}" +
                      $"&sortBy={sortBy}" +
                      $"&apiKey={ApiKey}";

            var response = await Http.GetFromJsonAsync<NewsApiResponse>(url);

            if (response?.Articles?.Count > 0)
            {
                await ToastService.Success("検索成功", $"{response.TotalResults}件の記事が見つかりました");
            }
            else
            {
                await ToastService.Information("検索結果", "記事が見つかりませんでした");
            }

            return response;
        }
        catch (HttpRequestException ex) when (ex.Message.Contains("426"))
        {
            await ToastService.Warning("制限事項", "⚠️ NewsAPIの無料プランはlocalhost専用です。本番環境では動作しません。詳細はREADMEをご確認ください。");
            return null;
        }
        catch (Exception ex)
        {
            await ToastService.Error("エラー", $"エラーが発生しました: {ex.Message}");
            return null;
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    // 旧メソッド（後方互換性のため保持）
    private async Task<NewsApiResponse?> PerformSearch(string keyword, string language)
    {
        if (string.IsNullOrWhiteSpace(keyword))
        {
            return null;
        }

        isLoading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            // キーワードをスペースで分割してAND条件用に連結
            var keywords = string.Join(" AND ", keyword.Split(' ', StringSplitOptions.RemoveEmptyEntries));

            // URLエンコード
            var encodedKeywords = Uri.EscapeDataString(keywords);
            var from = dateFrom?.ToString("yyyy-MM-dd") ?? string.Empty;
            var to = dateTo?.ToString("yyyy-MM-dd") ?? string.Empty;

            // NewsAPI エンドポイント構築
            var url = $"{NewsAPIUrl}?q={encodedKeywords}" +
                      $"&from={from}&to={to}" +
                      $"&language={language}" +
                      $"&sortBy={selectedSortBy}" +
                      $"&apiKey={ApiKey}";

            var response = await Http.GetFromJsonAsync<NewsApiResponse>(url);

            if (response?.Articles?.Count > 0)
            {
                await ToastService.Success("検索成功", $"{response.TotalResults}件の記事が見つかりました");
            }
            else
            {
                await ToastService.Information("検索結果", "記事が見つかりませんでした");
            }

            return response;
        }
        catch (HttpRequestException ex) when (ex.Message.Contains("426"))
        {
            await ToastService.Warning("制限事項", "⚠️ NewsAPIの無料プランはlocalhost専用です。本番環境では動作しません。詳細はREADMEをご確認ください。");
            return null;
        }
        catch (Exception ex)
        {
            await ToastService.Error("エラー", $"エラーが発生しました: {ex.Message}");
            return null;
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    // 手動検索ボタン用
    public async Task SearchNewsManually()
    {
        if (string.IsNullOrWhiteSpace(searchKeywords))
        {
            await ToastService.Warning("キーワード入力", "キーワードを入力してください");
            return;
        }

        // リアクティブストリームに送信
        keywordSubject.OnNext(searchKeywords);
    }

    public async Task ClearSearch()
    {
        searchKeywords = string.Empty;
        dateFrom = DateTime.Today.AddDays(-7);
        dateTo = DateTime.Today;
        selectedLanguage = "jp";
        selectedSortBy = "publishedAt";
        searchResults = null;

        // リアクティブストリームをリセット（すべての条件）
        keywordSubject.OnNext(string.Empty);
        languageSubject.OnNext(selectedLanguage);
        dateFromSubject.OnNext(dateFrom);
        dateToSubject.OnNext(dateTo);
        sortBySubject.OnNext(selectedSortBy);

        await ToastService.Information("クリア", "検索条件をクリアしました");
    }

    private void OpenArticle(string url)
    {
        Navigation.NavigateTo(url, true);
    }

    // NewsAPI レスポンスモデル
    public class NewsApiResponse
    {
        [JsonPropertyName("status")]
        public string Status { get; set; } = string.Empty;

        [JsonPropertyName("totalResults")]
        public int TotalResults { get; set; }

        [JsonPropertyName("articles")]
        public List<Article> Articles { get; set; } = new();
    }

    public class Article
    {
        [JsonPropertyName("source")]
        public Source? Source { get; set; }

        [JsonPropertyName("author")]
        public string? Author { get; set; }

        [JsonPropertyName("title")]
        public string Title { get; set; } = string.Empty;

        [JsonPropertyName("description")]
        public string? Description { get; set; }

        [JsonPropertyName("url")]
        public string Url { get; set; } = string.Empty;

        [JsonPropertyName("urlToImage")]
        public string? UrlToImage { get; set; }

        [JsonPropertyName("publishedAt")]
        public DateTime? PublishedAt { get; set; }

        [JsonPropertyName("content")]
        public string? Content { get; set; }
    }

    public class Source
    {
        [JsonPropertyName("id")]
        public string? Id { get; set; }

        [JsonPropertyName("name")]
        public string Name { get; set; } = string.Empty;
    }
}
